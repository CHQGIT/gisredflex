<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>GISRED 360</title>
        <meta name="description" content="">
        <meta name="author" content="ehernanr">
        <meta name="viewport" content="width=device-width; initial-scale=1.0">
        <!-- Replace favicon.ico & apple-touch-icon.png in the root of your domain and delete these references -->
        <link rel="shortcut icon" href="/favicon.ico">
        <link rel="apple-touch-icon" href="/apple-touch-icon.png">
        <!-- jQuery library -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <!-- Latest compiled JavaScript -->
        <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
        <!-- CUSTOMS: BY EVE -->
        <link rel="stylesheet" href="css/index.css">
        <link rel="stylesheet" href="http://js.arcgis.com/3.13/esri/css/esri.css">
        <link rel="stylesheet" href="https://js.arcgis.com/3.15/dijit/themes/claro/claro.css">
        <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css">
        <script src="js/arcgisApi.js"></script>
        <script src="js/three.min.js"></script>
        <script src="js/photo-sphere-viewer.min.js"></script>
        <style>
</style>
        <script>

     var dojoConfig = {
        //Required if you have dojo widgets(aka.dijits) in your HTML
        parseOnLoad: true
      };

  	 var nomSSEESelected;
  	 var token;
     var customZoom;
     var coordSSEELong;
     var coordSSEELat;
     var foto;


   //  var directorioPrincipal = new String("http://gisred.chilquinta/360/");
     var directorioPrincipal = new String("/chilquinta/assets/images/360/SSEE/");
     var slash = "/";
     //var panoNom = new String(nomSSEESelected);
     var extension = new String(".jpg");
     var ubicacionFoto;
  	 var map;
     var point;



function initialize() {

     coordSSEELong = getURLParameter('latSSEE');
     coordSSEELat = getURLParameter('lonSSEE');
     nomSSEESelected = getURLParameter('nombreSSEE');

     customZoom = getURLParameter('zoom');
     token =  getURLParameter('token');
    dojo.require("dojo.parser");
    dojo.require("esri.geometry.Point");
    dojo.require("esri.tasks.query");
    dojo.ready(pageReady);

    }

function getURLParameter(name) {
    return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [,""])[1].replace(/\+/g, '%20')) || null;
  }

</script>
        <script>

function pageReady() {
      var urlToken = "http://gisred.chilquinta/arcgis/rest/services/Varios/360/MapServer?token="+token;
      point = new esri.geometry.Point(coordSSEELat, coordSSEELong);
      map = new esri.Map("mapDiv",{});

     var layer = new esri.layers.ArcGISDynamicMapServiceLayer(urlToken);
     map.addLayer(layer);
     /*map.on("load", function() {
       map.centerAndZoom(point,customZoom);
     });
     */
     var queryTask = new esri.tasks.QueryTask("http://gisred.chilquinta/arcgis/rest/services/Varios/360/MapServer/0?token="+token);
     var query = new esri.tasks.Query();
     query.where = "SSEE = '" + nomSSEESelected + "'";
     query.returnGeometry = true;
     query.outFields = ["SSEE","NOMBRE_FOTO", "IDPUNTO", "ZOOM"];
     queryTask.execute(query, addPointsToMap);

    }
function addPointsToMap(featureSet) {
      map.zoomTo(featureSet.features.geometry);
      //Define symbology
      var defaultRenderer = new esri.renderer.SimpleRenderer(new esri.symbol.SimpleMarkerSymbol().setColor(new dojo.Color([255,129,0,0.30])));
      map.graphics.setRenderer(defaultRenderer);

      var features = featureSet.features;
      console.log(map.extent);
      dojo.forEach(features,function(feature){
      map.graphics.add(feature);

      });
      dojo.connect(map.graphics,"onClick",identifyFeatures);
     }

function identifyFeatures(evt){

      var extentGeom = pointToExtent(map,evt.mapPoint,10);
      var filteredGraphics = dojo.filter(map.graphics.graphics, function(graphic) {
       		 return extentGeom.contains(graphic.geometry);
     		 });
	  var content = "";
      //Build a table containing a row for each feature found
      dojo.forEach(filteredGraphics,function(row){
      foto = row.attributes.NOMBRE_FOTO;

        ubicacionFoto = directorioPrincipal.concat(nomSSEESelected).concat(slash).concat(foto).concat(extension);


		var div = document.getElementById('your-pano');
		var PSV = new PhotoSphereViewer({
			// Panorama, given in base 64
			panorama: ubicacionFoto,

			// Container
			container: div,

			// Deactivate the animation
			time_anim: false,

			// Display the navigation bar
			navbar: true,

			// Resize the panorama
			size: {
				width: '100%',
				height: '500px'
			},
			min_fov: 30,
			// No XMP data
			usexmpdata: false
		});



        });
}

 function pointToExtent(map, point,toleranceInPixel) {
    //calculate map coords represented per pixel
    var pixelWidth = map.extent.getWidth() / map.width;
    //calculate map coords for tolerance in pixel
    var toleraceInMapCoords = toleranceInPixel * pixelWidth;
    //calculate & return computed extent
    return new esri.geometry.Extent( point.x - toleraceInMapCoords,
      point.y - toleraceInMapCoords,
      point.x + toleraceInMapCoords,
      point.y + toleraceInMapCoords,
      map.spatialReference );
}




    </script>
    </head>
    <body onload="initialize();" class="claro">
        <div class="container-fluid" id="contenedorPrincipal">
            <div class="container" id="contenedorPaneles">
                <div class="row columnsContainer">
                    <div class="col-sm-8 containerPano">
                        <h5>Panorámica</h5>
                        <div id="your-pano" class="divPano"></div>
                    </div>
                    <!-- panel izquierdo -->
                    <!-- panel derecho -->
                    <div class="col-sm-4 containerPano">
                        <h5>Plano</h5>
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div id="mapDiv">
                                    <!-- <div data-dojo-type="dojox.layout.ResizeHandle"data-dojo-props="targetId:'mapDiv',activeResize:true,intermediateChanges:true"></div>-->
                                </div>
                            </div>
                        </div>
                        <div class="container" id="contenedorHeader">
                            <div class="page-header">
                                <header class="banner">
</header>
                                <h6>GISRED 360 -2016 <br> &copy;Planificacion y Gestión de la información Operacional</h6>
                            </div>
                        </div>
                        <!--
                        <div class="panel panel-default" id="panelLista">
                           <h4 class="text-center">Lista de Fotos</h4>
                              <div class="list-group text-center">
                                <a href="" class="list-group-item">Primera Foto</a>
                                <a href="" class="list-group-item">Segunda Foto</a>
                                <a href="" class="list-group-item">Tercera Foto</a>
                              </div>
                         </div>
                       -->
                    </div>
                </div>
                <!-- div row -->
            </div>
            <!-- contenedor paneles cierre -->
        </div>
        <!-- contenedor principal -->
    </body>
